/**@license
 BetConstruct Swarm API v1.0
 (c) 2013-2016 BetConstruct. http://www.betconstruct.com
 License: MIT
 */
angular.module("vbet5",["ngCookies"]).run(["Zergling",function(e){"use strict";e.init()}]),angular.module("vbet5").constant("Config",{main:{site_id:"175",source:"1",useAuthCookies:!1,authSessionLifetime:6e5},env:{lang:"eng"},swarm:{debugging:!1,languageMap:{pol:"eng",por:"por_2","pt-br":"por",fre:"fra",chi:"zho",mac:"mkd",bgr:"bul",lat:"lav",fas:"far",rum:"ron"},sendSourceInRequestSession:!1,sendTerminalIdlInRequestSession:!1,webSocketTimeout:5e3,url:[{url:"http://swarm-demo-spring.betcoswarm.com/",weight:10}],websocket:[{url:"ws://swarm-demo-spring.betcoswarm.com/",weight:10}],useWebSocket:!0,maxWebsocketRetries:5,webSocketRetryInterval:2e3}}),angular.module("vbet5").service("AuthData",["$window","$cookies","Config","Storage",function(e,n,t,o){"use strict";var a={};return a.partnerAuthData=null,a.integrationMode=!1,a.set=function(r){if(a.integrationMode)a.partnerAuthData=r;else if(o.set("auth_data",r,r.never_expires?null:t.main.authSessionLifetime),t.main.useAuthCookies){var s={domain:e.location.hostname.split(/\./).slice(-2).join("."),path:"/",expires:new Date((new Date).getTime()+(r.never_expires?t.main.saveLoginDataLifeTime:t.main.authSessionLifetime))};n.putObject("auth_data",r,s)}},a.get=function(){return a.integrationMode?a.partnerAuthData:t.main.useAuthCookies?n.getObject("auth_data"):o.get("auth_data")},a.clear=function(){a.integrationMode?a.partnerAuthData=null:(o.remove("auth_data"),t.main.useAuthCookies&&(n.remove("auth_data"),a.set("")))},a.getAuthToken=function(){var e=a.get();return e?e.auth_token:null},a}]),angular.module("vbet5").service("Storage",function(){"use strict";var e={},n="",t={},o=!0;try{amplify.store("storage_initialization_ok",null)}catch(e){o=!1}return e.set=function(e,a,r){return o?amplify.store(n+e,a,{expires:r}):(t[e]=a.toString(),!0)},e.get=function(e){return o?amplify.store(n+e):t[e]},e.remove=function(e){return o?amplify.store(n+e,null):void delete t[e]},e.setKeyNamePrefix=function(e){n=e},e}),angular.module("vbet5").service("Utils",["Config",function(e){"use strict";var n={};return n.getWeightedRandom=function(e,n){n=n||"weight";var t,o=[];angular.forEach(e,function(e){if(!e.ignore)for(t=0;t<(e[n]||1);t++)o.push(e)});var a=Math.floor(Math.random()*o.length);return o[a]},n.getLanguageCode=function(n){return e.swarm.languageMap&&e.swarm.languageMap[n]?e.swarm.languageMap[n]:n},n}]),angular.module("vbet5").service("WS",["$q","$rootScope","$timeout","$window","Config","Utils",function(e,n,t,o,a,r){"use strict";function s(){k=!1,y.close(),console.log("error")}function i(){k=!0,f.resolve(!0),b.instanceRetryCount=0,b.wasAbleToConnectPreviously=!0,L=!0,I=0,console.log("Socket has been opened"),angular.forEach(_,function(e){e()})}function c(e){try{return JSON.parse(e.data)}catch(n){return console.warn("cannot parse websocket response:",e.data,n),null}}function u(e,n){return n(e),e}function l(e){var t=c(e);null!==t&&(t.rid&&S.hasOwnProperty(t.rid)?(a.swarm.debugging&&t&&t.data&&t.data.subid&&(v[t.rid].receiveTs=(new Date).getTime(),v[t.rid].receive=e.data.length,h[t.data.subid]=t.rid),n.$apply(S[t.rid].cb.resolve({data:t})),delete S[t.rid]):t.data&&0===parseInt(t.rid,10)?(a.swarm.debugging&&Object.keys(t.data).forEach(function(e){var n=JSON.stringify(t.data[e]).length,o=h[e];v[o].updates+=n}),O.reduce(u,{data:t})):t.rid?console.warn("Got second response for request or invalid rid:",e.data):console.warn("Got response without rid:",e.data))}function d(){if(f)m=f.promise;else{k=!1,f=e.defer(),m=f.promise;var n=function(){console.log("Giving up. Websockets are not available."),f.reject("websocket error"),p.isAvailable=!1,C&&(console.log("WS calling onNotAvailableCallback callback"),C())};try{b=r.getWeightedRandom(a.swarm.websocket),console.log("websocketUrl selected:",b),y=new WebSocket(b.url),setTimeout(function(){k||y.close()},a.swarm.webSocketTimeout),console.log("Socket created:",y)}catch(e){console.log("Error creating socket",e,b),b||n()}y.onclose=function(e){return k=!1,console.log("socket closed",e,S,I),1001===e.code?(console.log("tab closed or refreshed, won't call onClose handlers",e),void y.close()):(T&&(console.log("WS calling onClose callback"),T()),I<a.swarm.maxWebsocketRetries||L?(p.isAvailable=!0,f=null,I++,b.instanceRetryCount=b.instanceRetryCount||0,b.instanceRetryCount++>0&&!b.wasAbleToConnectPreviously&&(b.ignore=!0),console.log("retry count",I,"retrying in ",a.swarm.webSocketRetryInterval*I,"msec",b),t(d,a.swarm.webSocketRetryInterval*I)):void n())},y.onerror=s,y.onmessage=l,y.onopen=i}return m}function g(){return w+=1,w>1e5&&(w=0),(new Date).getTime()+w.toString()}var f,m,b,v={},h={},p={},S={},w=0,k=!1,_=[],O=[],y={},T=null,C=null,I=0,L=!1;return p.isAvailable="function"==typeof WebSocket||"object"==typeof WebSocket,o.dumpWSStatistics=function(){var e=parseInt((new Date).getTime()/1e3,10);angular.forEach(v,function(n,t){n.requestRTT=parseInt(n.receiveTs-n.sentTs,10),n.updateTime=e-parseInt(n.receiveTs/1e3,10),console.log("req %s sent %s received %s (rtt %s ms) updates %s (in %s sec, avg %d b/sec) %s",t,n.sent,n.receive,n.requestRTT,n.updates,n.updateTime,n.updates/n.updateTime,n.unsubscribed?"ENDED":"")}),console.log(v)},p.sendRequest=function(n){return d().then(function(){var t=e.defer(),o=g();S[o]={time:new Date,cb:t},n.rid=o;var r=JSON.stringify(n);if(a.swarm.debugging)if("unsubscribe"===n.command){var s=h[n.params.subid];v[s].unsubscribed=!0,v[s].sent+=r.length}else v[o]={request:r,sent:r.length,receive:0,subId:null,updates:0,sentTs:(new Date).getTime(),unsubscribed:!1};return y.send(r),t.promise},function(){return e.reject("websocket connection not available")}).catch(function(n){return console.warn(n),e.reject(n)})},p.addSubscriptionListener=function(e){O.push(e)},p.onConnect=function(e){_.push(e)},p.connect=function(){return d()},p.setOnCloseCallback=function(e){T=e},p.onNotAvailable=function(e){C=e},p}]),angular.module("vbet5").service("Zergling",["Config","WS","$http","$q","$timeout","$rootScope","AuthData","Utils",function(e,n,t,o,a,r,s,i){"use strict";function c(){return w||(w=i.getWeightedRandom(e.swarm.url).url,console.log("long Polling URL selected:",w)),w}function u(e,n){if(void 0===e||!(e instanceof Object))throw new Error("wrong call");angular.forEach(n,function(n,t){if(null===n)delete e[t];else if("object"!=typeof n)e[t]=n;else if("object"!=typeof e[t]||null===e[t])e[t]=n;else{var o,a=void 0!==e[t].price;a&&(o=e[t].price),u(e[t],n),a&&(e[t].price_change=n.price===o?null:2*(o<n.price)-1)}})}function l(){console.log("resubscribing",O,_),angular.forEach(_,function(e,n){delete _[n],k.subscribe(e.request,e.callback)})}function d(e){angular.forEach(e.data,function(e,n){var t=_[n];void 0!==t&&void 0!==t.callback?(u(t.data,{data:e}),t.callback(t.data.data)):void 0===_[n]&&(console.log("got update for unknown subscription",n,"trying to unsubscribe"),k.unsubscribe(n))})}function g(n){var t=n.data.code;t=void 0===t?n.data.data.code:t,t===k.codes.OK?d(n.data):t!==k.codes.SESSION_LOST||y?console.log(n):(e.env.authorized=!1,h=null,l())}function f(){var a;if(!h){h=o.defer(),a=h.promise;var s={command:"request_session",params:{language:i.getLanguageCode(e.env.lang),site_id:e.main.site_id}};e.swarm.sendSourceInRequestSession&&void 0!==e.main.source&&(s.params.source=e.main.source),e.swarm.sendTerminalIdlInRequestSession&&void 0!==e.main.terminalId&&(s.params.terminal=e.main.terminalId),y=!0;var u=function(e){return y=!1,e.data.data&&e.data.data.sid?(h.resolve(e.data.data.sid),r.$broadcast("zergling.gotSession"),S?(S=!1,k.login(null).then(l)):l(),a=h.promise):(h=null,console.warn("got invalid response to request_session , sid not present",JSON.stringify(e)),a=o.reject(e)),a};return O?(console.log("requesting new session (WS)"),a=n.sendRequest(s).then(u)):(console.log("requesting new session (LP)"),t.post(c(),JSON.stringify(s)).success(function(e){a=u({data:e})}).catch(function(e){h=null,a=o.reject(e)})),a}return a=h.promise}function m(){h?f().then(function(e){var n={command:"whats_up"},o={"swarm-session":e};return t.post(c(),JSON.stringify(n),{headers:o})}).then(function(e){g(e),a(m,500)}).catch(function(e){console.log(e),404===e.status&&(h=null),a(m,5e3)}):a(m,1e3)}function b(){p=o.defer();var e=p.promise;return O?e=n.connect().then(function(){p.resolve(!0)},function(){return O=!1,console.log("Websocket not available",O),l(),p.reject(!1),p.promise}):p.resolve(!0),e}function v(e){return O&&n.isAvailable?b().then(function(){return f().then(function(t){return n.sendRequest(e)},function(e){return console.error("cannot get session and don't know what to do now :(",e),o.reject(e)})},function(){return v(e)}):(console.log("sending request (LP)"),O&&k.init(),f().then(function(n){var o={"swarm-session":n};return t.post(c(),JSON.stringify(e),{headers:o})}))}var h,p,S,w,k={},_={},O=!1,y=!1;return k.codes={OK:0,SESSION_LOST:5,NEED_TO_LOGIN:12},k.init=function(){console.log('%c     ."".    ."",\n     |  |   /  / \n     |  |  /  /  \n     |  | /  /   \n     |  |/  ;-._ \n     }  ` _/  / ;\n     |  /` ) / /\n     | /  /_/_/\\\n     |/  /      |\n     (  \' \\ \'-  |\n      \\    `.  / \n       |      |  \n       |      |  \n       init',"color: red; font-weight: bold; font-family:monospace;",n.isAvailable),e.swarm.useWebSocket&&n.isAvailable?(console.log("Config.swarm.useWebSocket",e.swarm.useWebSocket,e),n.addSubscriptionListener(g),n.onNotAvailable(function(){k.init(),l()}),n.setOnCloseCallback(function(){h=null,r.$broadcast("zergling.lostWSConnection"),n.onConnect(f)}),O=!0):(O=!1,m())},k.login=function(n,t,a){var i,c=s.get();if(null===n){if(!c)return console.warn("cannot login, no saved credentials"),o.reject(null);i={command:"restore_login",params:{user_id:c.user_id,auth_token:c.auth_token}}}else i=n.facebook?{command:"facebook_login",params:{access_token:n.access_token}}:n.odnoklassniki?{command:"ok_login",params:{access_token:n.accessToken,session_secret_key:n.sessionSecretKey}}:{command:"login",params:{username:n.username,password:n.password}};return r.loginInProgress=!0,a&&angular.forEach(a,function(e,n){i.params[n]=e}),v(i).then(function(a){if(a.data.code===k.codes.OK){if(console.log("zergling got login response",a),S=!0,e.env.authorized=!0,n&&a.data.data.auth_token){var r={auth_token:a.data.data.auth_token,user_id:a.data.data.user_id,never_expires:t||void 0};n&&n.username&&(r.login=n.username),s.set(r)}return a.data}return e.env.authorized=!1,o.reject(a.data)}).catch(function(t){return t.code===k.codes.SESSION_LOST?(r.$broadcast("zergling.sessionLost"),y||(h=null),k.login(n)):(e.env.authorized=!1,console.log("login fail, code:",t),o.reject(t))}).finally(function(){r.loginInProgress=!1})},k.logout=function(){var e={command:"logout",params:{}};return v(e).then(function(e){return s.clear(),e.data.code===k.codes.OK?(S=!1,e.data):o.reject(e.data.code)}).catch(function(e){return e===k.codes.SESSION_LOST?(r.$broadcast("zergling.sessionLost"),y||(h=null),k.logout()):(s.clear(),console.log("logout fail, code:",e),o.reject(e))})},k.get=function(n,t){t=t||"get";var a={command:t,params:n};return v(a).then(function(e){return e.data.code===k.codes.OK?e.data.data:o.reject(e.data)}).catch(function(a){return a.code===k.codes.SESSION_LOST?(e.env.authorized=!1,r.$broadcast("zergling.sessionLost"),y||(h=null),k.get(n,t)):a===k.codes.NEED_TO_LOGIN?(e.env.authorized=!1,k.login(null).then(function(){return k.get(n,t)})):(console.log("get fail:",a),o.reject(a))})},k.subscribe=function(n,t){n.subscribe=!0;var a={command:"get",params:n};return console.log("subscribing",JSON.stringify(n)),v(a).then(function(e){return e.data.code===k.codes.OK&&e.data.data.subid?(_[e.data.data.subid]={request:n,callback:t,data:e.data.data||{}},e.data.data):o.reject(e.data.code)}).catch(function(a){return a===k.codes.SESSION_LOST?(r.$broadcast("zergling.sessionLost"),y||(h=null),k.subscribe(n,t)):a===k.codes.NEED_TO_LOGIN?(e.env.authorized=!1,k.login(null).then(function(){return k.subscribe(n,t)})):(console.log("subscribe fail, code:",a),o.reject(a))})},k.unsubscribe=function(e){if(console.log("unsubscribing",e),void 0===e)return void console.warn("zergling unsubscribe got undefined subscription id");var n,t,a,s=[];return t=function(n){return n.data.code!==k.codes.OK?o.reject(n.data.code):void console.log(e," unsubscribe ok")},a=function(n){return n===k.codes.SESSION_LOST?(r.$broadcast("zergling.sessionLost"),y||(h=null),k.unsubscribe(e)):(console.log("unsubscribe fail, code:",n),delete _[e],o.reject(n))},angular.isArray(e)?angular.forEach(e,function(e){delete _[e],n={command:"unsubscribe",params:{subid:e.toString()}},s.push(v(n).then(t).catch(a))}):(delete _[e],n={command:"unsubscribe",params:{subid:e.toString()}},s.push(v(n).then(t).catch(a))),o.all(s)},k}]);